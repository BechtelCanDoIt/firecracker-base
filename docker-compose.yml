# =============================================================================
# firecracker-base - Docker Compose
# =============================================================================
# Hardware-isolated MicroVM with Docker inside.
#
# Requirements:
#   - Linux host with KVM enabled (/dev/kvm)
#   - Docker with BuildKit
#
# Usage:
#   # Build (requires privileged for loop mount - uses docker-container builder)
#   docker buildx create --name firecracker-builder --use --driver docker-container
#   docker buildx build --load --allow security.insecure -t firecracker-base:latest .
#
#   # Or use the build script:
#   ./build.sh
#
#   # Run
#   docker compose run --rm firecracker-base
#
#   # Inside VM:
#   docker run hello-world
#   docker compose up
# =============================================================================

services:
  firecracker-base:
    image: firecracker-base:latest
    container_name: firecracker-vm
    hostname: firecracker-host
    
    # =========================================================================
    # REQUIRED: KVM Access and networking
    # =========================================================================
    devices:
      - /dev/kvm:/dev/kvm
      - /dev/net/tun:/dev/net/tun
    
    # =========================================================================
    # REQUIRED: Capabilities
    # =========================================================================
    cap_add:
      - NET_ADMIN   # TAP device creation, iptables rules
      - NET_RAW     # Raw sockets for ping, debugging
      - SYS_ADMIN   # Mount workspace image (loop device)
      - MKNOD       # Create /dev/net/tun if needed
    
    # =========================================================================
    # SECURITY
    # =========================================================================
    # Note: On systems without AppArmor, remove or comment out the apparmor line
    security_opt:
      - apparmor:unconfined  # Required for TAP device and iptables
      - seccomp:unconfined   # Allow all syscalls for Firecracker VMM
    
    # =========================================================================
    # VOLUMES
    # =========================================================================
    volumes:
      # Your project directory - mounted at /workspace in VM
      - ${HOST_WORKSPACE:-./workspace}:/workspace:rw
    
    # =========================================================================
    # ENVIRONMENT
    # =========================================================================
    environment:
      # VM Resources (sized for Docker workloads)
      - FC_VCPU=${FC_VCPU:-30}
      - FC_MEM=${FC_MEM:-20000}
      - FC_WORKSPACE_SIZE=${FC_WORKSPACE_SIZE:-10000}
      
      # Logging
      - FC_LOG_LEVEL=${FC_LOG_LEVEL:-Warning}
      
      # Network configuration (optional overrides)
      - FC_TAP_IP=${FC_TAP_IP:-172.16.0.1}
      - FC_VM_IP=${FC_VM_IP:-172.16.0.2}
    
    # =========================================================================
    # BEHAVIOR
    # =========================================================================
    stdin_open: true
    tty: true
    privileged: false
    
    # =========================================================================
    # SYSCTLS - Required for NAT/routing
    # =========================================================================
    sysctls:
      # Enable IP forwarding for NAT to VM
      net.ipv4.ip_forward: 1
      # Allow forwarding on all interfaces
      net.ipv4.conf.all.forwarding: 1
      # Disable reverse path filtering (can cause issues with TAP)
      net.ipv4.conf.all.rp_filter: 0
      net.ipv4.conf.default.rp_filter: 0
